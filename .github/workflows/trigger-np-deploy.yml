name: Trigger np Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dispatch:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: ${{ vars.NP_SITE_REPO }}
    steps:
      - name: Trigger deploy in site repository
        env:
          TOKEN: ${{ secrets.NP_DEPLOY_TOKEN }}
          SHA: ${{ github.sha }}
        run: |
          if [ -z "${TARGET_REPO}" ]; then
            echo "Missing repository variable NP_SITE_REPO (format: owner/repo)"
            exit 1
          fi

          if [ -z "${TOKEN}" ]; then
            echo "Missing secret NP_DEPLOY_TOKEN"
            exit 1
          fi

          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${TOKEN}" \
            https://api.github.com/repos/${TARGET_REPO}/dispatches \
            -d "{\"event_type\":\"content-updated\",\"client_payload\":{\"content_sha\":\"${SHA}\"}}"
